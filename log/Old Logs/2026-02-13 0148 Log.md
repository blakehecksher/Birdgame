# Networking Engineering Log

## 1. Current Architecture Snapshot
- Transport:
  - PeerJS WebRTC data channels (`src/network/PeerConnection.ts`).
  - Host room id format `birdgame-<ROOMCODE>`.
  - ICE config now explicitly includes STUN servers (Google STUN); TURN still not wired.
- Authority model:
  - Host-authoritative simulation and collision resolution in `src/core/Game.ts`.
  - Clients send intent-only `INPUT_UPDATE`; host clamps input ranges in `src/network/NetworkManager.ts`.
  - Role/lifecycle updates are host-originated (`ROLE_ASSIGNMENT`, `PLAYER_LEFT`, `ROUND_START`, `ROUND_END`).
- Tick/update rates:
  - Authoritative tick basis: `GAME_CONFIG.TICK_RATE = 30`.
  - Input uplink: `INPUT_SEND_RATE = 30`.
  - Dynamic player sync: `PLAYER_SNAPSHOT_RATE = 20`.
  - World keyframe sync: `WORLD_KEYFRAME_RATE = 1`.
- State sync strategy:
  - Frequent `STATE_SYNC` carries player dynamic state + `serverTick`.
  - World lists (`foods`, `npcs`) sent as keyframes, not every packet.
  - Late join sync uses `FULL_STATE_SNAPSHOT` chunking with `snapshotId`, `chunkIndex`, `totalChunks`.
  - Client interpolation/reconciliation now tick-based, not host/client wall-clock aligned.
- Player lifecycle:
  - Host tracks pending peers through explicit states (connecting/requested/accepted/ready/active) in `NetworkManager`.
  - Join pipeline: `JOIN_REQUEST -> JOIN_ACCEPT/JOIN_DENY -> FULL_STATE_SNAPSHOT -> JOIN_READY -> ROLE_ASSIGNMENT(join_activated)`.
  - Max room size enforced as 4 players via `GAME_CONFIG.MAX_PLAYERS`.
  - Host disconnect policy implemented as graceful termination signal (`HOST_TERMINATING`) best-effort on dispose.

## 2. Major Decisions + Rationale
- Decision: Keep PeerJS + host-authoritative topology.
  - Problem: Architecture was functional but brittle under join churn and clock skew.
  - Options:
    - Keep current stack and harden protocol/lifecycle.
    - Rewrite transport/authority.
  - Why chosen: Minimal migration risk, preserves existing gameplay code paths, enough capacity for 2-4 players.
- Decision: Add explicit join handshake and activation gate.
  - Problem: Prior flow treated data-channel-open as playable; clients could move before full sync.
  - Options:
    - Keep implicit open-state.
    - Add staged join messages with readiness ack.
  - Why chosen: Removes race conditions and unsynced control entry; supports late join deterministically.
- Decision: Use server tick sequence for interpolation/reconciliation.
  - Problem: Date-based sync drift under normal clock skew caused jitter and incorrect stale-reject behavior.
  - Options:
    - Keep wall-clock compensation heuristics.
    - Use monotonic host tick envelope in protocol.
  - Why chosen: Deterministic ordering, robust under clock skew, simpler stale filtering.
- Decision: Host disconnect policy is graceful termination (no migration).
  - Problem: Host loss previously undefined.
  - Options:
    - Host migration.
    - Match termination.
  - Why chosen: Migration in browser P2P introduces split-brain/election/state-transfer risk not justified for current scope.
- Decision: Deterministic pigeon reassignment on pigeon disconnect.
  - Problem: Pigeon leave could stall round progression.
  - Options:
    - End round always.
    - Promote deterministic hawk.
  - Why chosen: Preserves continuity/fairness mid-round; fallback to waiting state when no hawks remain.

## 3. Implementation Plan (Executed / Remaining)
- Phase 0: Persistent memory file.
  - Executed: this file created as baseline.
- Phase 1: Protocol/lifecycle foundation.
  - Executed in:
    - `src/network/messages.ts`
    - `src/network/NetworkManager.ts`
    - `src/network/PeerConnection.ts`
    - `src/config/constants.ts`
  - Implemented: handshake messages, protocol envelope, join accept/deny paths, host termination message, input clamps.
- Phase 2: Authoritative player lifecycle + role safety.
  - Executed in:
    - `src/core/GameState.ts`
    - `src/core/Game.ts`
  - Implemented: max-player guard, active/inactive connection state, deterministic pigeon reassignment path, waiting-state fallback.
- Phase 3: Sync pipeline hardening.
  - Executed in:
    - `src/network/NetworkManager.ts`
    - `src/core/Game.ts`
  - Implemented: keyframe world sync cadence, stale-player removal, tick-based interpolation/reconciliation.
- Phase 4: Spawn fairness + join UX lock.
  - Executed in:
    - `src/core/Game.ts`
  - Implemented: safe spawn candidate scoring with min-distance constraints, pigeon spawn protection tick usage, hawk input lock tick usage.
- Phase 5: Mobile/perf polish.
  - Executed in:
    - `src/rendering/SceneManager.ts`
  - Implemented: debug grid now configurable (`SHOW_DEBUG_GRID=false`).

## 4. Known Risks
- TURN not configured yet.
  - STUN-only is insufficient for some carrier-grade NAT paths; invite reliability ceiling remains.
- Host lifecycle message is best-effort.
  - `HOST_TERMINATING` cannot be guaranteed on abrupt tab kill/device sleep.
- Host simulation still runs inside frame loop.
  - No strict fixed-step accumulator loop in `Game.update`; host frame drops can degrade authority quality.
- Snapshot chunking format is coarse.
  - Chunk payload repeats non-array baseline fields; acceptable at current room size but inefficient.
- Reconnect identity continuity remains partial.
  - Reconnect can still yield new peer IDs; deterministic identity remap is not fully solved.
- UI/UX for host waiting state is functional but not polished.
  - Host transitions between lobby/hud are now stateful but could be tightened for clarity.

## 4.1 Top 5 Friend-Invite Failure Modes + Defenses
- Failure: Invite opens but room is full.
  - Defense: Host enforces `MAX_PLAYERS` and returns `JOIN_DENY(room_full)`; client exits cleanly to lobby.
- Failure: Data channel opens but client starts unsynced.
  - Defense: Explicit handshake gate; controls remain disabled until `FULL_STATE_SNAPSHOT` applied + `JOIN_READY` + host activation.
- Failure: Mid-game leave creates ghost actor or bad role map.
  - Defense: Host emits `PLAYER_LEFT`, removes authoritative state, client stale-player cleanup pass prunes absent peers.
- Failure: Pigeon disconnect stalls round timer/logic.
  - Defense: Deterministic hawk promotion path + spawn protection; fallback to `insufficient_players` waiting state if no hawk available.
- Failure: Cellular/NAT path fails to establish or sustain direct P2P.
  - Defense: STUN configured now; remaining mitigation required is TURN deployment + explicit NAT failure UX.

## 5. Instructions for Future Agents
- Start reading here:
  - `src/network/NetworkManager.ts` (protocol envelope, handshake, sync cadence, interpolation)
  - `src/core/Game.ts` (authoritative lifecycle, disconnect/reassign behavior, control gating)
  - `src/core/GameState.ts` (player lifecycle data model)
  - `src/network/messages.ts` (public wire schema)
- Safe extension points:
  - Add protocol messages in `messages.ts` first, then dispatch/send in `NetworkManager`.
  - Keep role and round transitions centralized in host-side `Game.ts` methods.
  - Keep client controls gated via `setControlsEnabled` + `NetworkManager.setClientInputEnabled`.
- Dangerous areas:
  - Any logic that mutates player roster without broadcasting `PLAYER_LEFT` / `ROLE_ASSIGNMENT`.
  - Any new wall-clock assumptions in interpolation/reconciliation paths.
  - Any direct trust of client-provided physics values.
- Do not rewrite:
  - Do not replace PeerJS transport in this hardening branch unless TURN integration proves insufficient and failure metrics justify migration.
  - Do not invert authority model; retain host-authoritative collisions and scoring.

## 6. Change Log (Append-Only)
- 2026-02-13 0148
  - Added protocol envelope fields (`protocolVersion`, `msgSeq`, optional `matchId`, `serverTick`).
  - Added join lifecycle messages and handlers (`JOIN_REQUEST`, `JOIN_ACCEPT`, `JOIN_DENY`, `FULL_STATE_SNAPSHOT`, `JOIN_READY`).
  - Added role/lifecycle events (`ROLE_ASSIGNMENT`, `PLAYER_LEFT`, `HOST_TERMINATING`, `PING`, `PONG`).
  - Hardened host input handling with server-side clamps and activation gating.
  - Switched interpolation/reconciliation from timestamp dependence to server tick dependence.
  - Split dynamic state sync from world keyframe sync and removed high-frequency full-world spam.
  - Added stale-player cleanup from authoritative snapshots.
  - Added host-side disconnect handling with deterministic pigeon reassignment and waiting-state fallback.
  - Added spawn safety scoring with building clearance + distance constraints.
  - Added configurable debug-grid disable path for mobile/perf.
  - Extended tests for join lifecycle, activation gating, stale player cleanup, and GameState lifecycle helpers.
- 2026-02-13 follow-up (post-hardening polish)
  - Raised NPC sync cadence to 12Hz (`NPC_SNAPSHOT_RATE`) while keeping food keyframe sync at 1Hz to eliminate point-to-point NPC movement artifacts.
  - Preserved NPC respawn timers in game-state mirror paths (`syncNPCStateToGameState` / `syncNPCStateFromGameState`) so dead/respawned NPC visuals stay coherent.
  - Relaxed interpolation/reconciliation defaults (`STATE_BUFFER_TIME`, interpolation min/max, reconcile thresholds) to reduce visible jitter under real-world jitter and mobile variance.
  - Moved round countdown overlay toward top center and below instruction overlay z-order so first-play instructions remain readable.
- 2026-02-13 follow-up (mobile invite reliability)
  - Added PeerJS signaling disconnect handlers for host/client to trigger automatic signaling reconnect after app backgrounding.
  - Added foreground resume refresh (`refreshPresence`) and visibility/focus hooks in `Game` so host lobby re-advertises promptly when returning from Messages/app switch.
  - Added host-side status messaging when signaling is paused/restored so users know when invite links are temporarily unreachable.
- 2026-02-13 follow-up (joiner jitter regression fix)
  - Identified regression cause: interpolation render time on clients was derived from `lastObservedServerTick` only, which updates only when packets arrive; between packets the effective render tick froze, producing hold-then-jump motion.
  - Added `lastObservedServerTickAtMs` tracking and `getEstimatedObservedServerTick()` in `NetworkManager` to advance render tick continuously between arrivals while capping extrapolated tick age.
  - Updated server-tick observation path (`JOIN_ACCEPT`, `FULL_STATE_SNAPSHOT`, `STATE_SYNC`, `ROUND_START`) to use a single monotonic updater.
  - Updated remote interpolation to use estimated server tick instead of static last packet tick.
  - Updated local reconciliation staleness check in `Game` to use estimated server tick so stale authoritative snapshots are not treated as perpetually fresh during packet gaps.
  - Added regression test in `tests/network/NetworkManager.test.cjs` verifying interpolation position continues to progress between two snapshots when no new packet arrives.
- 2026-02-13 follow-up (smoothness-first tuning for friend sessions)
  - Tradeoff decision: bias toward visual smoothness over strict responsiveness/precision for non-competitive friend play.
  - In `NetworkManager.handleStateSync`, added stale out-of-order packet drop (`serverTick` lag > 2 ticks behind latest observed) to prevent late-packet snap-backs.
  - In `NetworkManager.applyStateSync`, stopped hard-applying remote transform packets directly to `GameState` for non-local players; remote visuals now come from interpolation path to avoid packet-arrival snapping.
  - In client remote render path (`Game.update`), added secondary visual smoothing (lerp + angle blend) with hard-snap only on large divergence.
  - In client local reconciliation (`Game.reconcileLocalPlayerWithAuthority`), reduced correction frequency and blend aggressiveness to reduce camera/body micro-jitter.
  - Retuned defaults in `constants.ts` for smoother play under jitter:
    - higher interpolation delay and min/max buffer window,
    - reduced extrapolation cap,
    - looser reconcile snap thresholds.
  - Added regression test for stale out-of-order state sync ignore behavior in `tests/network/NetworkManager.test.cjs`.
- 2026-02-13 follow-up (location desync correction)
  - Added host-side stale input neutralization (`REMOTE_INPUT_STALE_MS=300`) so authority no longer continues movement on stale client intents during packet gaps.
  - Extended host remote input cache with `lastUpdateAtMs`; `getRemoteInput` now zeros axes/mouse when input age exceeds stale budget.
  - Tightened local-authority convergence logic in `Game.reconcileLocalPlayerWithAuthority`:
    - correction cadence restored to ~30Hz,
    - persistent drift timer introduced (`localAuthorityDriftMs`),
    - forced snap on sustained medium drift (not only extreme one-frame errors),
    - dynamic blend strength increased with error ratio.
  - Added regression test `host neutralizes stale remote input after packet gap` in `tests/network/NetworkManager.test.cjs`.
  - Added separate jitter-analysis-only note (no fix) in `log/2026-02-13 2148 Log.md`.
- 2026-02-13 follow-up (numeric room codes)
  - Switched host room-code generation from alphanumeric to numeric-only 6-digit format in `Game.generateRoomCode`.
  - Kept join parsing backward-compatible so existing alphanumeric `birdgame-<code>` entries still resolve.
  - Updated join input UX to numeric keypad hint (`inputmode=\"numeric\"`, `pattern=\"[0-9]*\"`) and numeric placeholder.
- 2026-02-13 follow-up (desktop join input regression fix)
  - Removed restrictive join input HTML attributes (`inputmode=\"numeric\"` + `pattern`) to restore reliable desktop typing behavior.
  - Updated `LobbyUI.showJoinScreen` to always focus the room-code input and select prefilled text, instead of focusing the Connect button when a code is present.
  - Numeric code generation remains unchanged; this patch is UX/input reliability only.
